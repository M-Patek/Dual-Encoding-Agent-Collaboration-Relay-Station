import time
import sys
import os
from playwright.sync_api import sync_playwright, Page, TimeoutError as PlaywrightTimeoutError

# ====================================================================
# === I. é˜¶æ®µé›¶ï¼šå‰ç½®ä¾èµ–ä¸å…¨å±€å¸¸é‡è§„èŒƒ (FINAL LOCATORS) ===
# ====================================================================

# ----------------- åä½œå¸¸é‡ -----------------
TERMINATION_PHRASE = "TASK_COMPLETED_SUCCESSFULLY" 
RECOVERY_MESSAGE = "Due to a technical issue, this session may have timed out. Please resend your last message."
START_CMD_MSG = "Please start the dual-encoding collaboration process and begin your coordination task."
SAFETY_BUFFER_SEC = 15 

# ----------------- UI å®šä½å™¨å¸¸é‡ -----------------
INPUT_SEL = 'role=textbox' 
HISTORY_SEL = '#chat-history-scroll-container' 
# ğŸš¨ ã€å·²ä¿®æ”¹ã€‘ä½¿ç”¨æ›´é€šç”¨çš„çˆ¶çº§ Classï¼Œç¡®ä¿èƒ½é€‰ä¸­æ‰€æœ‰æ¶ˆæ¯
LATEST_MSG_SEL = '.message-content'
# å…¼å®¹ä¸­æ–‡å’Œè‹±æ–‡çš„åœæ­¢æŒ‰é’®
DONE_STATUS_SEL = 'button[aria-label="åœæ­¢å›å¤"], button[aria-label="Stop responding"]' 
# ----------------------------------------------------------------------------

# å®šä¹‰ä¸€ä¸ªç®€åŒ–çš„æ—¥å¿—å‡½æ•°
def log(level: str, message: str, step: str = "ORCHESTRATOR"):
    """è®°å½•å¸¦æœ‰æ—¶é—´æˆ³ã€çº§åˆ«å’Œæ­¥éª¤ä¿¡æ¯çš„æ—¥å¿—ã€‚"""
    timestamp = time.strftime("%Y-%m-%d %H:%M:%S")
    print(f"[{timestamp}][{level:<5}][{step:<15}] {message}")

def step_log(message: str, agent_name: str):
    """ç”¨äºè®¾ç½®é˜¶æ®µçš„è¯¦ç»†æ­¥éª¤è·Ÿè¸ªæ—¥å¿—ã€‚"""
    log("TRACE", message, agent_name)

# --- æ ¸å¿ƒè¾…åŠ©å‡½æ•°ï¼šé¡µé¢ç¨³å®šæ£€æŸ¥ ---
def wait_for_page_stability(page: Page, agent_name: str):
    """ç­‰å¾…é¡µé¢ç¨³å®šï¼šç›´æ¥ç­‰å¾…æ ¸å¿ƒè¾“å…¥æ¡†å‡ºç°ã€‚"""
    TIMEOUT_MS = 30000 
    log("INFO", f"ç­‰å¾… {agent_name} é¡µé¢ç¨³å®š (è¾“å…¥æ¡†, è¶…æ—¶ {TIMEOUT_MS//1000}s)...", "PAGE_WAIT")
   
    try:
        # ç›´æ¥ç­‰å¾…è¾“å…¥æ¡†å‡ºç°
        page.locator(INPUT_SEL).wait_for(timeout=TIMEOUT_MS)
        log("SUCCESS", f"{agent_name} æ ¸å¿ƒè¾“å…¥æ¡†å¯è§ã€‚", "PAGE_WAIT")
        step_log(f"{agent_name} é¡µé¢å·²å‡†å¤‡å¥½æ¥å—è¾“å…¥ã€‚", "SETUP")
    except PlaywrightTimeoutError:
        log("FATAL", f"{agent_name} é¡µé¢ç¨³å®šå¤±è´¥ (æœªæ‰¾åˆ°æ ¸å¿ƒè¾“å…¥æ¡†)ã€‚", "PAGE_WAIT")
        raise Exception("é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œæ— æ³•ç»§ç»­ã€‚")


# === II. é˜¶æ®µä¸€ï¼šé²æ£’æ€§å°è£…å‡½æ•°ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰ ===

def handle_termination(final_message: str):
    """ç»ˆæ­¢ä¸äº¤ä»˜ï¼ˆç¡¬åœæ­¢ï¼‰ã€‚"""
    log("FATAL", "ç»ˆæ­¢ä¿¡å·å·²å‘ç°ã€‚ç¨‹åºæ‰§è¡Œç¡¬åœæ­¢ã€‚", "TERMINATION")
    log("INFO", f"Agent A çš„æœ€ç»ˆæ¶ˆæ¯å†…å®¹:\n---\n{final_message}\n---", "TERMINATION")
    log("INFO", "è¯·æ£€æŸ¥æµè§ˆå™¨çª—å£è·å–æœ€ç»ˆç»“æœã€‚è„šæœ¬ä¸ä¼šå…³é—­æµè§ˆå™¨ã€‚", "TERMINATION")
    sys.exit(0)


def send_message_robust(page: Page, message: str, current_len_of_target: int, is_target_A: bool) -> int:
    """1. ç¡®ä¿æ¶ˆæ¯æäº¤æˆåŠŸï¼Œå¹¶å¯¹æ¶ˆæ¯æ°”æ³¡çš„å‡ºç°è¿›è¡ŒåŒé‡éªŒè¯ (å®‰å…¨æ¨¡å¼ï¼Œæ—  Eval)ã€‚"""
    agent_name = "Agent A" if is_target_A else "Agent B"
    
    log("INFO", f"å°è¯•èšç„¦å¹¶å‘é€æ¶ˆæ¯ç»™ {agent_name}. é•¿åº¦: {len(message)}", "SEND_ROBUST")
    
    try:
        page.bring_to_front()
        
        input_locator = page.locator(INPUT_SEL)
        input_locator.fill(message)
        input_locator.press("Enter")
        log("INFO", f"æ¶ˆæ¯å·²å‘é€ç»™ {agent_name}.", "SEND_ROBUST")
        
        # æ ¡éªŒ 1ï¼šä¿®å¤ 'state="empty"' å…¼å®¹æ€§é—®é¢˜ï¼Œæ”¹ç”¨å¾ªç¯æ£€æŸ¥è¾“å…¥å€¼
        start_time = time.time()
        max_wait = 5.0  # 5ç§’ç­‰å¾…è¾“å…¥æ¡†æ¸…ç©º
        is_cleared = False
        
        while time.time() - start_time < max_wait:
            time.sleep(0.2)
            # ä½¿ç”¨ inner_text() æˆ– input_value() æ£€æŸ¥æ˜¯å¦ä¸ºç©º
            try:
                if not input_locator.inner_text().strip():
                    is_cleared = True
                    break
            except Exception:
                # å¿½ç•¥æŠ¥é”™ï¼Œç»§ç»­ç­‰å¾…
                pass
        
        if is_cleared:
             log("SUCCESS", "è¾“å…¥æ¡†å·²æ¸…ç©º (æäº¤ç¡®è®¤).", "SEND_ROBUST")
        else:
             log("WARN", "è¾“å…¥æ¡†æœªæ¸…ç©ºï¼ç»§ç»­æ°”æ³¡æ£€æŸ¥ã€‚", "SEND_ROBUST")


        # æ ¡éªŒ 2ï¼šç­‰å¾…æ–°çš„ç”¨æˆ·æ°”æ³¡å‡ºç° (å®‰å…¨æ¨¡å¼ï¼Œé¿å… EvalError)
        start_wait_time = time.time()
        timeout = 30 # å»¶é•¿è¶…æ—¶æ—¶é—´åˆ° 30 ç§’
        new_len = current_len_of_target
        
        while time.time() - start_wait_time < timeout:
            time.sleep(0.5)
            new_len = page.locator(LATEST_MSG_SEL).count()
            if new_len > current_len_of_target:
                break
        
        if new_len <= current_len_of_target:
            log("FATAL", f"æ¶ˆæ¯å·²å‘é€ï¼Œä½†åœ¨ {timeout}s åæœªå‡ºç°æ°”æ³¡ã€‚", "SEND_ROBUST")
            # ğŸš¨ è‡´å‘½é”™è¯¯ï¼šæ°”æ³¡æœªèƒ½å‡ºç°ï¼Œå¯èƒ½æ˜¯å®šä½å™¨é”™è¯¯æˆ– Edge å®‰å…¨é™åˆ¶
            raise Exception("æ¶ˆæ¯æäº¤å¤±è´¥ï¼Œæ°”æ³¡æ•°é‡æœªå¢åŠ ã€‚")
            
        # ä¿®æ­£æ—¥å¿—ï¼šæ˜ç¡®è¯´æ˜å†å²è®°å½•æ¡æ•°æ˜¯ä»å“ªä¸ªæ•°å­—å¢åŠ åˆ°å“ªä¸ªæ•°å­—
        log("SUCCESS", f"æ°”æ³¡æ ¡éªŒæˆåŠŸ. å†å²æ¡æ•°: {current_len_of_target} -> {new_len}", "SEND_ROBUST")
        
        return new_len

    except Exception as e:
        log("FATAL", f"å‘é€æ¶ˆæ¯ç»™ {agent_name} å‘ç”Ÿè‡´å‘½é”™è¯¯: {e}", "SEND_ROBUST")
        raise


def get_latest_message_safe(page: Page, is_agent_A: bool):
    """
    2. æ‰§è¡Œâ€œå…ˆç­‰åå–â€ï¼Œä¿è¯æå–çš„æ˜¯ AI å®Œæˆç”Ÿæˆåçš„å®Œæ•´æ–‡æœ¬ã€‚
    """
    agent_name = "Agent A" if is_agent_A else "Agent B"
    
    log("INFO", f"ç­‰å¾… {agent_name} å®Œæˆç”Ÿæˆã€‚", "GET_SAFE")
    try:
        # ç­‰å¾…åœæ­¢æŒ‰é’®æ¶ˆå¤± (60s è¶…æ—¶)
        page.locator(DONE_STATUS_SEL).wait_for(state="hidden", timeout=60000)
        log("SUCCESS", f"{agent_name} ç”Ÿæˆæ ‡è®°æ¶ˆå¤±ã€‚", "GET_SAFE")
    except PlaywrightTimeoutError:
        log("WARN", f"{agent_name} ç”Ÿæˆæ ‡è®°æœªæ¶ˆå¤± (è¶…è¿‡ 60s)ã€‚å¼ºåˆ¶æå–ã€‚", "GET_SAFE")

    # æå–æ–‡æœ¬å¹¶æ›´æ–°å†å²é•¿åº¦
    try:
        latest_message_locator = page.locator(LATEST_MSG_SEL).last
        # ç­‰å¾…å…ƒç´ å¯è§ï¼Œç¡®ä¿æ–‡æœ¬æ¸²æŸ“å®Œæˆ
        latest_message_locator.wait_for(timeout=10000)
        
        message_text = latest_message_locator.inner_text().strip()
        new_len = page.locator(LATEST_MSG_SEL).count() 
        
        log("SUCCESS", f"{agent_name} æ¶ˆæ¯æå–æˆåŠŸ. æ–°å†å²æ¡æ•°: {new_len}", "GET_SAFE")
        return message_text, new_len
        
    except Exception as e:
        log("FATAL", f"æ— æ³•ä» {agent_name} æå–æœ€æ–°æ¶ˆæ¯: {e}", "GET_SAFE")
        raise Exception("æ— æ³•ä» UI æå–æœ€æ–°æ¶ˆæ¯ã€‚")


def wait_for_response_loop(page: Page, current_len: int, is_agent_A: bool):
    """3. é²æ£’æ€§ç­‰å¾…å›å¤ã€‚ä¸»ç­‰å¾…æ—¶é—´å¢åŠ åˆ° 180 ç§’ï¼Œä»¥åº”å¯¹é•¿å›å¤ã€‚"""
    agent_name = "Agent A" if is_agent_A else "Agent B"
    start_time = time.time()
    last_path_a_check = start_time
    
    TIMEOUT_LOOP_SEC = 180 # å»¶é•¿åˆ° 3 åˆ†é’Ÿ
    
    log("INFO", f"å¼€å§‹ç­‰å¾… {agent_name} å›å¤. é¢„æœŸå†å²é•¿åº¦ > {current_len}", "WAIT_LOOP")

    while (time.time() - start_time) < TIMEOUT_LOOP_SEC: 
        time.sleep(1) # æ¯ç§’æ£€æŸ¥ä¸€æ¬¡

        current_time = time.time()
        # å†…éƒ¨æ£€æµ‹ï¼šå‘ç°æ–°æ¶ˆæ¯ï¼Œç«‹å³è¿”å›
        new_len = page.locator(LATEST_MSG_SEL).count()
        if new_len > current_len:
            elapsed = current_time - start_time
            log("SUCCESS", f"{agent_name} å›å¤æ”¶åˆ°ï¼Œè€—æ—¶: {elapsed:.2f}s.", "WAIT_LOOP")
            return new_len

        # è·¯å¾„ A æ¢å¤ (æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡æäº¤å¡é¡¿)
        if (current_time - last_path_a_check) >= 10:
            last_path_a_check = current_time
            
            input_locator = page.locator(INPUT_SEL)
            
            try:
                # æ£€æŸ¥è¾“å…¥æ¡†æ˜¯å¦æœ‰å†…å®¹ (å³ä¸Šæ¬¡å‘é€å¯èƒ½å¡ä½äº†)
                if input_locator.inner_text().strip():
                    log("WARN", f"è·¯å¾„ A è§¦å‘é‡è¯•: {agent_name} è¾“å…¥æ¡†ä»æœ‰æ–‡æœ¬. å°è¯•é‡å‘ Enter.", "WAIT_LOOP")
                    input_locator.press("Enter")
            except Exception as e:
                # å…¼å®¹æ€§æ£€æŸ¥ï¼Œå¦‚æœå®šä½å™¨æŠ¥é”™ï¼Œæˆ‘ä»¬è·³è¿‡å®ƒ
                log("INFO", f"è·¯å¾„ A æ£€æŸ¥è·³è¿‡ (æ— æ³•è·å–è¾“å…¥å€¼): {e}", "WAIT_LOOP")
                pass 


    # --- 180 ç§’è¶…æ—¶è§¦å‘ ---
    log("WARN", f"{TIMEOUT_LOOP_SEC}s è¶…æ—¶ï¼ {agent_name} æœªåœ¨è§„å®šæ—¶é—´å†…å›å¤.", "WAIT_LOOP")
    
    # å®‰å…¨ç¼“å†²æ£€æŸ¥
    log("INFO", f"è¿›å…¥ {SAFETY_BUFFER_SEC}s å®‰å…¨ç¼“å†²ç­‰å¾…æœŸ.", "WAIT_LOOP")
    buffer_start_time = time.time()
    while (time.time() - buffer_start_time) < SAFETY_BUFFER_SEC:
        time.sleep(1)
        new_len = page.locator(LATEST_MSG_SEL).count()
        if new_len > current_len:
            elapsed = time.time() - start_time
            log("SUCCESS", f"æ…¢é€Ÿç”Ÿæˆè¢«æ•è·! {agent_name} åœ¨ç¼“å†²æœŸå›å¤ï¼Œæ€»è€—æ—¶: {elapsed:.2f}s.", "WAIT_LOOP")
            return new_len
            
    log("WARN", "å®‰å…¨ç¼“å†²æœŸç»“æŸï¼Œæœªå‘ç°æ–°æ¶ˆæ¯.", "WAIT_LOOP")

    # è·¯å¾„ B æ¢å¤ (å‘é€æ¢å¤æŒ‡ä»¤)
    try:
        page.bring_to_front()
        log("WARN", "è·¯å¾„ B (ç”Ÿæˆå¡ä½): å°è¯•å‘é€æ¢å¤æŒ‡ä»¤.", "WAIT_LOOP")
        
        # 1. å°è¯•ä¸­æ­¢
        page.keyboard.press("Escape") 

        # 2. å‘é€æ¢å¤æŒ‡ä»¤
        input_locator = page.locator(INPUT_SEL)
        input_locator.fill(RECOVERY_MESSAGE)
        input_locator.press("Enter")
        log("SUCCESS", "æ¢å¤æŒ‡ä»¤å·²å‘é€. é‡ç½®è®¡æ—¶å™¨ï¼Œç»§ç»­ç­‰å¾….", "WAIT_LOOP")
        
        # é‡æ–°å¯åŠ¨ 180s è®¡æ—¶å™¨ï¼Œå¹¶ä»å¾ªç¯èµ·ç‚¹ç»§ç»­ç­‰å¾… (é€’å½’è°ƒç”¨)
        return wait_for_response_loop(page, current_len, is_agent_A) 

    except Exception as e:
        log("FATAL", f"è·¯å¾„ B æ¢å¤å¤±è´¥: æ— æ³•å‘é€æ¢å¤æŒ‡ä»¤: {e}", "WAIT_LOOP")
        raise


# === III. é˜¶æ®µäºŒï¼šä¸»ç¨‹åºé€»è¾‘ï¼ˆOrchestrator å¾ªç¯ï¼‰ ===

def run_orchestrator(page_A: Page, page_B: Page, len_A: int, len_B: int):
    """ä¸»ç¨‹åºå…¥å£ï¼ŒåŒ…å«å¯åŠ¨é€»è¾‘å’Œæ ¸å¿ƒåä½œå¾ªç¯ã€‚"""
    log("INFO", "=== è„šæœ¬å¯åŠ¨ï¼šæ‰§è¡Œå¯åŠ¨é€»è¾‘æ£€æŸ¥ ===", "MAIN")

    # 1. å¯åŠ¨æ—¶è·å– A çš„æœ€ç»ˆå†å²é•¿åº¦ (è¿™æ˜¯ä½ æ‰‹åŠ¨æ“ä½œåçš„ç»“æœ)
    current_len_A = page_A.locator(LATEST_MSG_SEL).count()
    current_len_B = page_B.locator(LATEST_MSG_SEL).count()
    
    log("INFO", f"æœ€ç»ˆæµ‹é‡çš„åˆå§‹å†å²è®°å½•. A: {current_len_A}, B: {current_len_B}", "MAIN_START")

    # 2. æ£€æŸ¥ Agent A æ˜¯å¦å·²æœ‰åˆå§‹ä»»åŠ¡å’Œå›å¤
    if current_len_A == 0: 
        # A å†å²è®°å½•ä¸ºç©ºç™½ï¼Œéœ€è¦å‘é€å¯åŠ¨æŒ‡ä»¤
        log("WARN", "Agent A å†å²è®°å½•ä¸ºç©ºç™½ã€‚å‘é€å¯åŠ¨æŒ‡ä»¤.", "MAIN_START")
        
        len_A = send_message_robust(page_A, START_CMD_MSG, current_len_A, True)
    else:
        # A å†å²è®°å½•ä¸ä¸ºç©º (len_A >= 1)ï¼Œæ„å‘³ç€ä½ å·²ç»è®¾ç½®äº†åˆå§‹ä»»åŠ¡ã€‚
        log("INFO", f"æ£€æµ‹åˆ° Agent A å†å²è®°å½• ({current_len_A} æ¡æ¶ˆæ¯)ã€‚å¼€å§‹åˆå§‹ä»»åŠ¡å¤„ç†.", "MAIN_START")
        
        # A çš„æƒ…å†µï¼šç”¨æˆ·å‘é€äº†å¥‡æ•°æ¡ï¼ˆä¾‹å¦‚1, 3, 5ï¼‰ï¼ŒAIå›å¤äº†å¶æ•°æ¡ï¼ˆä¾‹å¦‚2, 4, 6ï¼‰ã€‚
        if current_len_A % 2 == 0 and current_len_A >= 2:
            # å¶æ•°æ¡ï¼šæœ€æ–°ä¸€æ¡æ˜¯ AI å›å¤ï¼Œéœ€è¦è½¬å‘
            log("INFO", "æœ€æ–°æ¶ˆæ¯æ˜¯ A çš„å›å¤ã€‚å‡†å¤‡è½¬å‘ç»™ Agent B.", "A_TURN_INIT")
            
            # æå– AI çš„æœ€æ–°å›å¤ (å³åˆå§‹è®¡åˆ’)
            message_A, len_A_new = get_latest_message_safe(page_A, True) 
            
            # A3. A â†’ B è½¬å‘æ¶ˆæ¯
            log("INFO", "A3. è½¬å‘ Agent A çš„åˆå§‹è®¡åˆ’ç»™ Agent B.", "A_TURN_INIT")
            len_B = send_message_robust(page_B, message_A, current_len_B, False)

            # æµç¨‹å·²å¯åŠ¨ï¼Œæ›´æ–° len_A å’Œ len_B ä¸ºå½“å‰å€¼ï¼Œå¹¶è¿›å…¥ä¸»å¾ªç¯ç­‰å¾… B å›å¤
            len_A = current_len_A
            len_B = len_B 
            
        else:
            # å¥‡æ•°æ¡ï¼šæœ€æ–°ä¸€æ¡æ˜¯ä½ çš„è¾“å…¥ï¼Œè„šæœ¬éœ€è¦ç­‰å¾… A çš„å›å¤
            log("INFO", "æœ€æ–°æ¶ˆæ¯æ˜¯ç”¨æˆ·è¾“å…¥ã€‚è¿›å…¥å¾ªç¯ç­‰å¾… Agent A çš„å›å¤.", "MAIN_START")
            len_A = current_len_A
            len_B = current_len_B 


    # å¦‚æœæ˜¯ç©ºç™½å¯åŠ¨ï¼Œ len_A å·²ç»é€šè¿‡ send_message_robust æ›´æ–°äº†ã€‚
    if current_len_A == 0:
        len_B = current_len_B
    
    # --- ä¸»å¾ªç¯ï¼ˆOrchestrator Cycleï¼‰ ---
    while True:
        log("=" * 40, "CYCLE_START", "ORCHESTRATOR")

        # --- A1/A2. Agent A (åè°ƒè€…) å›å¤å¤„ç† ---
        log("INFO", f"A1. ç­‰å¾… Agent A çš„å›å¤ (å½“å‰è®¡æ•°: {len_A})", "A_TURN")
        len_A = wait_for_response_loop(page_A, len_A, True)
        
        log("INFO", "A2. æå– Agent A çš„æ¶ˆæ¯.", "A_TURN")
        message_A, len_A = get_latest_message_safe(page_A, True) 

        # A2 Check. ç»ˆæ­¢æ£€æŸ¥
        if TERMINATION_PHRASE in message_A:
            handle_termination(message_A)
        
        # --- A3. A â†’ B è½¬å‘æ¶ˆæ¯ ---
        log("INFO", f"A3. è½¬å‘æ¶ˆæ¯ A â†’ B.", "A_TURN")
        len_B = send_message_robust(page_B, message_A, len_B, False)

        log("-" * 40, "CYCLE_MIDDLE", "ORCHESTRATOR")

        # --- B1/B2. Agent B (æ‰§è¡Œè€…) å›å¤å¤„ç† ---
        log("INFO", f"B1. ç­‰å¾… Agent B çš„å›å¤ (å½“å‰è®¡æ•°: {len_B})", "B_TURN")
        len_B = wait_for_response_loop(page_B, len_B, False)

        log("INFO", "B2. æå– Agent B çš„æ¶ˆæ¯.", "B_TURN")
        message_B, len_B = get_latest_message_safe(page_B, False)

        # --- B3. B â†’ A è½¬å‘æ¶ˆæ¯ ---
        log("INFO", f"B3. è½¬å‘æ¶ˆæ¯ B â†’ A.", "A_TURN")
        len_A = send_message_robust(page_A, message_B, len_A, True)
        
        log("=" * 40, "CYCLE_END", "ORCHESTRATOR")


# --- ç¤ºä¾‹è¿è¡Œå—ï¼ˆPlaywright åˆå§‹åŒ–å’Œå¯åŠ¨ï¼‰ ---
if __name__ == '__main__':
    # ğŸš¨ ä½¿ç”¨æ‚¨çš„ä¸ªäºº Edge é…ç½®ï¼Œé¿å…é£æ§å’Œç™»å½•ã€‚
    # è·¯å¾„æ¥æºäºæ‚¨çš„æˆªå›¾ï¼šC:\Users\asus\AppData\Local\Microsoft\Edge\User Data
    EDGE_USER_DATA_PATH = "C:\\Users\\asus\\AppData\\Local\\Microsoft\\Edge\\User Data" 
    
    # ğŸš¨ ä½¿ç”¨ç”¨æˆ·æä¾›çš„ä¸“å± URL ğŸš¨
    GEMINI_URL_A = "https://gemini.google.com/u/1/app?hl=zh-cn"
    GEMINI_URL_B = "https://gemini.google.com/u/3/app?hl=zh-cn"
    
    # åœ¨ä¸»å‡½æ•°å¤–éƒ¨å®šä¹‰å˜é‡ï¼Œç”¨äºä¼ é€’ç»™ run_orchestrator
    page_A, page_B = None, None
    initial_len_A, initial_len_B = 0, 0
    context = None # å£°æ˜ context å˜é‡ 

    # --- 1. æµè§ˆå™¨å¯åŠ¨å’Œ Page åˆ›å»º (Edge - å•è¿›ç¨‹åŒ Page) ---
    with sync_playwright() as p:
        try:
            # 1.1 å¯åŠ¨ Edge æµè§ˆå™¨ (æŒä¹…åŒ–æ¨¡å¼ï¼Œä½¿ç”¨æ‚¨çš„ä¸ªäººæ•°æ®)
            log("INFO", "å¯åŠ¨ Edge æµè§ˆå™¨ (æŒä¹…åŒ–æ¨¡å¼ï¼Œä½¿ç”¨æ‚¨çš„ä¸ªäººæ•°æ®)...", "SETUP")

            # å¯åŠ¨ Edge, å¼ºåˆ¶ä½¿ç”¨æ‚¨çš„ Edge ç”¨æˆ·æ•°æ®ç›®å½• (Persistent Context)
            context = p.chromium.launch_persistent_context(
                user_data_dir=EDGE_USER_DATA_PATH,
                headless=False,
                channel="msedge", # å¼ºåˆ¶ä½¿ç”¨ Edge æµè§ˆå™¨
                slow_mo=100,
            )
            
            # 1.2 Agent A: ä½¿ç”¨ç°æœ‰ä¸Šä¸‹æ–‡åˆ›å»ºç¬¬ä¸€ä¸ª Page (æ ‡ç­¾é¡µ)
            log("INFO", "åˆ›å»º Agent A (ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ)...", "SETUP")
            # Persistent context é»˜è®¤ä¼šå¯åŠ¨ä¸€ä¸ªç©ºç™½é¡µï¼Œæˆ‘ä»¬ä½¿ç”¨ context.pages[0] æ¥æ¥ç®¡å®ƒ
            if not context.pages or context.pages[0].url != 'about:blank':
                page_A = context.new_page()
            else:
                page_A = context.pages[0]

            # å»¶è¿Ÿç¡®ä¿ Page å¯¹è±¡å®Œå…¨å°±ç»ª
            time.sleep(1) 
            
            # å…³é”®è°ƒæ•´ï¼šä½¿ç”¨ 'domcontentloaded' æ¨¡å¼ï¼Œé¿å… Edge ä¸ªäººé…ç½®çš„ç½‘ç»œå†²çª
            page_A.goto(GEMINI_URL_A, wait_until="domcontentloaded", timeout=90000) 
            
            wait_for_page_stability(page_A, "Agent A")
            
            page_A.bring_to_front()
            log("SUCCESS", "Agent A (Edge Page 1) å¯åŠ¨æˆåŠŸã€‚", "SETUP")

            
            # å¢åŠ å»¶è¿Ÿï¼Œç¡®ä¿ç¬¬ä¸€ä¸ªé¡µé¢å®Œå…¨ç¨³å®š
            time.sleep(5) 

            # 1.3 Agent B: åœ¨åŒä¸€æµè§ˆå™¨ä¸­åˆ›å»ºç¬¬äºŒä¸ª Page (æ ‡ç­¾é¡µ)
            log("INFO", "åˆ›å»º Agent B (ç¬¬äºŒä¸ªæ ‡ç­¾é¡µ)...", "SETUP")
            page_B = context.new_page() 
            
            # å»¶è¿Ÿç¡®ä¿ Page å¯¹è±¡å®Œå…¨å°±ç»ª
            time.sleep(1) 
            
            # å…³é”®è°ƒæ•´ï¼šä½¿ç”¨ 'domcontentloaded' æ¨¡å¼ï¼Œé¿å… Edge ä¸ªäººé…ç½®çš„ç½‘ç»œå†²çª
            page_B.goto(GEMINI_URL_B, wait_until="domcontentloaded", timeout=90000) 

            wait_for_page_stability(page_B, "Agent B")

            page_B.bring_to_front()
            
            log("SUCCESS", "åŒ Page (æ‚¨çš„ Edge) å·²å¯åŠ¨ã€‚", "SETUP")


            # --- 2. æ‰‹åŠ¨æ“ä½œçª—å£æœŸ ---
            log("WARN", "æç¤ºï¼šè„šæœ¬æ­£åœ¨ä½¿ç”¨æ‚¨çš„ Edge ä¸ªäººé…ç½® (é›¶ç™»å½•çŠ¶æ€)ã€‚", "MANUAL_STEP")
            MANUAL_SETUP_TIME = 90 
            log("WARN", f"è¯·åœ¨ {MANUAL_SETUP_TIME} ç§’å†…å®Œæˆåˆå§‹ä»»åŠ¡å‘é€ï¼ˆå‘é€ç»™ Agent A æ ‡ç­¾é¡µï¼‰ã€‚", "MANUAL_STEP")
            log("WARN", f"æç¤ºï¼šAgent A æ˜¯ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µï¼ŒURL: {GEMINI_URL_A}", "MANUAL_STEP")
            log("WARN", f"æç¤ºï¼šAgent B æ˜¯ç¬¬äºŒä¸ªæ ‡ç­¾é¡µï¼ŒURL: {GEMINI_URL_B}", "MANUAL_STEP")
            
            time.sleep(MANUAL_SETUP_TIME) 
            
            # ğŸš¨ å…³é”®ä¿®å¤ï¼šå»¶è¿Ÿè·å–å†å²é•¿åº¦ï¼Œç¡®ä¿æµè§ˆå™¨æ¸²æŸ“å®Œæ‰‹åŠ¨æ“ä½œåçš„å›å¤
            log("INFO", "ç­‰å¾… 5 ç§’ï¼Œç¡®ä¿æµè§ˆå™¨æ¸²æŸ“å®Œæ‰‹åŠ¨æ“ä½œåçš„å›å¤...", "SETUP")
            time.sleep(5) 

            # --- 3. è·å–åˆå§‹çŠ¶æ€å¹¶è¿è¡Œ ---
            try:
                # 3.1 å°è¯•è·å–åˆå§‹å†å²é•¿åº¦ (ä½¿ç”¨ç²¾ç¡®è®¡æ•°)
                initial_len_A = page_A.locator(LATEST_MSG_SEL).count()
                initial_len_B = page_B.locator(LATEST_MSG_SEL).count()
                log("INFO", f"åˆå§‹å†å²è®°å½•æ•°é‡è·å–å®Œæˆã€‚A: {initial_len_A}, B: {initial_len_B}", "SETUP")

                # 3.2 è°ƒç”¨ Orchestrator ä¸»å¾ªç¯
                run_orchestrator(
                    page_A=page_A, 
                    page_B=page_B, 
                    len_A=initial_len_A, 
                    len_B=initial_len_B
                )
                
            except Exception as e:
                log("FATAL", f"Orchestrator æµç¨‹é€€å‡ºæˆ–åˆå§‹åŒ–å¤±è´¥: {e}", "MAIN_EXIT")
            finally:
                log("INFO", "è„šæœ¬å·²é€€å‡ºã€‚æµè§ˆå™¨ä¿æŒå¼€å¯å¼€å¯çŠ¶æ€ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚", "MAIN_EXIT")
                # å…³é—­ context å®ä¾‹
                if context:
                    context.close()
                time.sleep(5) 

        except Exception as e:
            log("FATAL", f"Playwright åˆå§‹åŒ–æˆ–æµè§ˆå™¨å¯åŠ¨å¤±è´¥: {e}", "SETUP_FATAL")
            sys.exit(1)
